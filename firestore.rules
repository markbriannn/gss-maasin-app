rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN';
    }
    
    function isProvider() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'PROVIDER';
    }
    
    function isClient() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'CLIENT';
    }

    // ===== USERS COLLECTION =====
    match /users/{userId} {
      // Any authenticated user can read any user profile (needed for chat, provider listings, etc.)
      allow read: if isAuthenticated();
      
      // Users can create their own profile during registration
      allow create: if isUser(userId);
      
      // Users can update their own profile
      allow update: if isUser(userId) || isAdmin();
      
      // Only admins can delete users
      allow delete: if isAdmin();

      // ===== NESTED: EARNINGS SUBCOLLECTION =====
      match /earnings/{transactionId} {
        allow read: if isUser(userId) || isAdmin();
        allow create, update: if isUser(userId) || isAdmin();
      }

      // ===== NESTED: DOCUMENTS SUBCOLLECTION =====
      match /documents/{docId} {
        allow read: if isUser(userId) || isAdmin();
        allow write: if isUser(userId) || isAdmin();
      }
    }

    // ===== BOOKINGS COLLECTION =====
    match /bookings/{bookingId} {
      // Authenticated users can read bookings they're involved in
      allow read: if isAuthenticated();
      
      // Clients can create bookings
      allow create: if isAuthenticated();
      
      // Users can update bookings they're involved in
      allow update: if isAuthenticated();
      
      // Only admins can delete bookings
      allow delete: if isAdmin();
    }

    // ===== REVIEWS COLLECTION =====
    match /reviews/{reviewId} {
      // Anyone authenticated can read reviews
      allow read: if isAuthenticated();
      
      // Authenticated users can create reviews
      allow create: if isAuthenticated();
      
      // Users can update their own reviews, admins can update any
      allow update: if isAuthenticated();
      
      // Only admins can delete reviews
      allow delete: if isAdmin();
    }

    // ===== MESSAGES COLLECTION =====
    match /messages/{messageId} {
      // Authenticated users can read messages
      allow read: if isAuthenticated();
      
      // Users can send messages
      allow create: if isAuthenticated();
      
      // Users can update messages (mark as read)
      allow update: if isAuthenticated();
      
      // Admins can delete messages
      allow delete: if isAdmin();
    }

    // ===== CONVERSATIONS COLLECTION =====
    match /conversations/{conversationId} {
      // Authenticated users can read conversations
      allow read: if isAuthenticated();
      
      // Users can create conversations
      allow create: if isAuthenticated();
      
      // Users can update conversations (add participants, update last message, etc.)
      allow update: if isAuthenticated();
      
      // Messages subcollection
      match /messages/{messageId} {
        // Users can read messages in conversations
        allow read: if isAuthenticated();
        
        // Users can send messages
        allow create: if isAuthenticated();
        
        // Users can update message (read status, reactions)
        allow update: if isAuthenticated();
      }
    }

    // ===== NOTIFICATIONS COLLECTION =====
    match /notifications/{notificationId} {
      // Users can read their notifications
      allow read: if isAuthenticated();
      
      // System/users can create notifications
      allow create: if isAuthenticated();
      
      // Users can update notifications (mark as read)
      allow update: if isAuthenticated();
      
      // Users can delete their notifications
      allow delete: if isAuthenticated();
    }

    // ===== TRANSACTIONS COLLECTION =====
    match /transactions/{transactionId} {
      // Users can read transactions
      allow read: if isAuthenticated();
      
      // System can create transactions
      allow create: if isAuthenticated();
      
      // Admins can update transactions
      allow update: if isAdmin();
    }

    // ===== GAMIFICATION COLLECTION =====
    match /gamification/{docId} {
      // Anyone authenticated can read gamification data (for leaderboards)
      allow read: if isAuthenticated();
      
      // Users can create/update their own gamification data
      allow create, update: if isAuthenticated();
    }

    // ===== ADMIN LOGS COLLECTION =====
    match /adminLogs/{logId} {
      // Only admins can read logs
      allow read: if isAdmin();
      
      // System can create logs
      allow create: if isAuthenticated();
      
      // No updates or deletes to logs (immutable)
      allow update, delete: if false;
    }

    // ===== ANALYTICS COLLECTION =====
    match /analytics/{document=**} {
      // Authenticated users can read analytics
      allow read: if isAuthenticated();
      
      // Admins can write
      allow write: if isAdmin();
    }

    // ===== PROVIDERS COLLECTION (if separate from users) =====
    match /providers/{providerId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ===== SERVICES COLLECTION =====
    match /services/{serviceId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ===== JOBS COLLECTION =====
    match /jobs/{jobId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }

    // ===== CATEGORIES COLLECTION =====
    match /categories/{categoryId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ===== SETTINGS COLLECTION =====
    match /settings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ===== FCM TOKENS COLLECTION =====
    match /fcmTokens/{tokenId} {
      allow read, write: if isAuthenticated();
    }

    // ===== PAYMENTS COLLECTION =====
    match /payments/{paymentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
    }

    // ===== WALLETS COLLECTION =====
    match /wallets/{walletId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
    }

    // ===== CATCH-ALL: Allow authenticated users to read/write other collections =====
    // This is more permissive but prevents permission errors for collections not explicitly defined
    match /{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
  }
}
